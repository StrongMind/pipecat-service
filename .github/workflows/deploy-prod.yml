name: Deploy to production

on:
  workflow_run:
    workflows: [Build]
    branches: [main]
    types: [completed]
  workflow_dispatch:
    inputs:
      jira-ticket:
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}

jobs:
  deploy-auto:
    name: Autodeploy to ECS
    uses: strongmind/public-reusable-workflows/.github/workflows/aws-deploy-with-pulumi.yml@main
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    with:
      environment-name: ${{ inputs.environment-name }}
      web-container-image: ${{ inputs.web-repository-name }}:${{ github.event.workflow_run.head_sha }}
      worker-container-image: ${{ inputs.worker-repository-name }}:${{ github.event.workflow_run.head_sha }}
      pulumi-command: ${{ inputs.pulumi-command }}
      pulumi-bucket: ${{ inputs.pulumi-bucket }}
    secrets: inherit